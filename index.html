<script src="osf-marked.js"></script>
<script src="node_modules/ace-builds/src/ace.js"></script>
<script src="osf-language-tools.js"></script>
<script src="node_modules/jquery/dist/jquery.min.js"></script>
<!--Uncomment below for highlighting-->
<!--<script src="node_modules/highlight/lib/vendor/highlight.js/highlight.pack.js"></script>-->
<!--<script>hljs.initHighlightingOnLoad();</script>-->

<style type="text/css" media="screen">
    #editor {
        position: relative;
        height: 300px;
        width: 800px;
    }
</style>


<div id="editor">
Markdown Test
============
> There is a trailing space in the line above. This affects Markdown only.
> Blockquotes require two newlines in Marked.

## First Section ##
Lorem ipsum blah blah I **don't** remember the text, and I *don't* know latin.

[[user:nf3cv]]

### Youtube Subsection ###

[[youtube:lq4LBjhbB4U]]

## Second Section ##

There is a trailing space ~~in the line~~ above. This affects showdown only.
### Ordered List ###

1. Foo
1. Foo
1. Foo

### Unordered List ###

* Foo
- Foo
+ Foo

### My Little Table ###

Foo                 | Bar           | State
:------------------ | :-----------: | -----:
`Code aligned left` | Broken        | Really, really happy
Code                | In the center | Happy
Code                | Broken        | Happy

### Image Below ###
![puddle](https://raw.githubusercontent.com/rliebz/Puddle/master/Content/PC/stand.png "Mouseover Text")
And a corresponding link: https://github.com/rliebz/puddle
### Python Code Block ###
```python
s = "Python string"
if indent_exists_below:
    print s
```
</div>

<!--<button onclick="renderCode()">Render</button>-->

<div id="rendered"></div>


<script>

    var langTools = ace.require("ace/ext/language_tools");
    var editor = ace.edit("editor");
//    editor.setTheme("ace/theme/kuroir");
    editor.getSession().setMode("ace/mode/markdown");

    function renderCode() {
        document.getElementById("rendered").innerHTML = marked(editor.getSession().doc.getValue());
    }

    // Settings
    editor.getSession().setUseSoftTabs(true);       // Replace tabs with spaces
    editor.renderer.setShowGutter(false);           // Hides line numbers

    function parseUsers(data) {
        console.timeEnd('Ajax');
        var completions = [];
        var users = data.users;

        // Make user objects
        for (var i in users) {
            var user = users[i];
//            console.log('user', user.fullname);
            completions.push({
                caption: ' ' + user.fullname,
                value: '@' + user.fullname + ' ' + user.id,
                uid: user.id,
                score: 300,
                meta: user.id
            })
        }
        return completions
    }

    var example_users = [{
        caption: ' Aobert Aiebowitz',
        value: '@Aobert Aiebowitz rel5pd',
        uid: 'rel5pd',
        meta: 'rel5pd'
    },{
        caption: ' Josh Carp',
        value: '@Josh Carp jmcar',
        uid: 'jmcar',
        meta: 'jmcar'
    }];

    var resolvedQueries = {};
    var totalCompletions = [];

    function uniquify(array) {
        var output = array.concat();
        for(var i = 0; i < output.length; i++) {
            for(var j = i+1; j < output.length; j++) {
                if(output[i].uid === output[j].uid)
                    output.splice(j--, 1);
            }
        }

        return output;
    };

    function setCompleter() {
        var queryCompleter = {
            getCompletions: function(editor, session, pos, prefix, callback) {
                if (prefix.length === 0) { callback(null, []); return }

                if (prefix in resolvedQueries){
                    console.log('retrieved', prefix);
                    editor.loadingCompleters = false;
                    callback(null, totalCompletions)
                    return;
                }

                var url = 'http://localhost:5000/api/v1/user/search/?query=' + prefix.substring(1);

                console.time('Ajax');
                var completions = $.getJSON(url).then(parseUsers).then(function(completions) {
                    editor.loadingCompleters = false;
                    resolvedQueries[prefix] = completions;
                    totalCompletions = uniquify(totalCompletions.concat(completions));
                    console.log('--JSON RETRIEVED--\n', completions);
                    callback(null, totalCompletions);
                });
            }
        };

        editor.setOptions({enableCustomAutocompletion: [queryCompleter]});
    }

    function onChange(e) {
        renderCode();
    }

    // Initialize list
    setCompleter();
    editor.getSession().on('change', onChange);   // Render code on change

    renderCode();

</script>